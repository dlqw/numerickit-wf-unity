# Numeric System ä¸­æ–‡æ–‡æ¡£

<p align="center">
<img alt="Static Badge" src="https://img.shields.io/badge/field-gameplay-red">
<img src="https://img.shields.io/badge/script-csharp-yellow">
<img src="https://img.shields.io/badge/dotnet-Standard 2.1-green">
<img src="https://img.shields.io/badge/framework-WFramework-blue">
<img alt="Static Badge" src="https://img.shields.io/badge/tests-129%20passed-success">
<img alt="Static Badge" src="https://img.shields.io/badge/version-1.2.0-blue">
</p>

## ç®€ä»‹

Numeric System æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€çµæ´»æ€§é«˜çš„å·¥å…·é›†ï¼Œæ—¨åœ¨ä¸ºæˆ˜æ–—ç³»ç»Ÿçš„æ•°å€¼ç»“ç®—æä¾›ç®€å•ã€é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚

- **åŸºäº Event Store çš„æ•°å€¼å˜æ›´è®°å½•** - å¯æº¯æºï¼Œæ˜“è‡ªæ ¡éªŒï¼Œä¿éšœåŸå§‹æ•°æ®å®‰å…¨
- **å®šç‚¹æ•°è¿ç®—** - ç¡®ä¿å¤šå¹³å°å’Œè®¾å¤‡é—´çš„æ•°å€¼ä¸€è‡´æ€§ï¼Œæé«˜ç½‘ç»œåŒæ­¥å¯é æ€§
- **è¯­æ³•ç®€å•** - æ”¯æŒæ•´æ•°ã€æµ®ç‚¹æ•°ã€åˆ†æ•°æˆ–ç™¾åˆ†æ¯”çš„åŠ æ³•ã€ä¹˜æ³•ä¿®é¥°
- **å¯æ‰©å±•æ¶æ„** - æ”¯æŒè‡ªå®šä¹‰ä¿®é¥°ç¬¦ã€æ¡ä»¶ä¿®é¥°ç¬¦å’Œä¿®é¥°ç¬¦ä¼˜å…ˆçº§
- **çº¿ç¨‹å®‰å…¨æ“ä½œ** - ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒæä¾›çº¿ç¨‹å®‰å…¨åŒ…è£…
- **åºåˆ—åŒ–æ”¯æŒ** - å†…ç½®ä¿®é¥°ç¬¦åºåˆ—åŒ–/ååºåˆ—åŒ–åŠŸèƒ½

## æ›´æ–°æ—¥å¿—

### ç‰ˆæœ¬ 1.2.0 - é«˜çº§åŠŸèƒ½ä¸æ€§èƒ½ä¼˜åŒ– (2025-02-03)

æ­¤ä¸»è¦ç‰ˆæœ¬æ·»åŠ äº†é«˜çº§åŠŸèƒ½ï¼ŒåŒæ—¶ä¿æŒ 100% å‘åå…¼å®¹ï¼š

**æ–°åŠŸèƒ½ï¼š**
- âœ¨ **ä¿®é¥°ç¬¦ä¼˜å…ˆçº§ç³»ç»Ÿ** - ä½¿ç”¨ç»†ç²’åº¦ä¼˜å…ˆçº§æ§åˆ¶ä¿®é¥°ç¬¦åº”ç”¨é¡ºåº
- âœ¨ **æ¡ä»¶ä¿®é¥°ç¬¦** - åŸºäºåŠ¨æ€æ¡ä»¶åº”ç”¨ä¿®é¥°ç¬¦ï¼ˆè°“è¯æ¡ä»¶ï¼‰
- âœ¨ **åºåˆ—åŒ–æ”¯æŒ** - æ”¯æŒä¿®é¥°ç¬¦çš„åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œç”¨äºå­˜æ¡£/è¯»æ¡£
- âœ¨ **çº¿ç¨‹å®‰å…¨åŒ…è£…** - ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒæä¾›çº¿ç¨‹å®‰å…¨çš„ `Numeric` æ“ä½œ
- âœ¨ **æ€§èƒ½åŸºå‡†æµ‹è¯•** - ä½¿ç”¨ BenchmarkDotNet çš„å…¨é¢åŸºå‡†æµ‹è¯•å¥—ä»¶
- âœ¨ **è¯Šæ–­å·¥å…·** - å¢å¼ºè°ƒè¯•å’Œè¯Šæ–­åŠŸèƒ½
- âœ¨ **æµç•… API** - ä¸°å¯Œçš„æ‰©å±•æ–¹æ³•å’Œæ„å»ºå™¨æ¨¡å¼ï¼Œæå‡å¼€å‘ä½“éªŒ

**æ”¹è¿›ï¼š**
- ğŸš€ æµ‹è¯•è¦†ç›–ç‡ä» 117 å¢åŠ åˆ° **129 ä¸ªæµ‹è¯•**ï¼ˆ100% é€šè¿‡ç‡ï¼‰
- ğŸš€ å¢å¼ºé”™è¯¯æ¶ˆæ¯å’ŒéªŒè¯
- ğŸš€ æ”¹è¿›ç¼“å­˜æœºåˆ¶
- ğŸš€ æå‡ä¿®é¥°ç¬¦æŸ¥è¯¢æ€§èƒ½

**æ–‡æ¡£ï¼š**
- ğŸ“š å®Œæ•´çš„ XML æ–‡æ¡£æ³¨é‡Šè¦†ç›–
- ğŸ“š æ€§èƒ½åŸºå‡†æµ‹è¯•æ–‡æ¡£
- ğŸ“š æ¶æ„é‡æ„è®¡åˆ’

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [CHANGELOG.md](./CHANGELOG.md)

### ç‰ˆæœ¬ 1.1.0 - é€»è¾‘ä¿®å¤ä¸å®‰å…¨å¢å¼º (2025-02-03)

- **ä¿®å¤é™¤é›¶é”™è¯¯**: åœ¨ `FractionNumericModifier` æ„é€ å‡½æ•°ä¸­æ·»åŠ éªŒè¯
- **ä¿®å¤å¤šåˆ†æ•°ä¿®é¥°ç¬¦é”™è¯¯**: é‡æ–°è®¾è®¡ `Apply` æ–¹æ³•
- **æ·»åŠ æº¢å‡ºä¿æŠ¤**: é˜²æ­¢æç«¯è®¡ç®—å¯¼è‡´çš„é™é»˜å€¼æŸå
- **æ”¹è¿› CustomNumericModifier å®‰å…¨æ€§**: å¢å¼ºç©ºå€¼æ£€æŸ¥

è¯¦ç»†ä¿¡æ¯è¯·å‚é˜… [changelogs/1.1.0_CN.md](./changelogs/1.1.0_CN.md)

## ç›®å½•

- [ç®€ä»‹](#ç®€ä»‹)
- [æ›´æ–°æ—¥å¿—](#æ›´æ–°æ—¥å¿—)
- [ä¸‹è½½å’Œéƒ¨ç½²](#ä¸‹è½½å’Œéƒ¨ç½²)
  - [ä» GitHub è·å–](#ä»-github-è·å–)
  - [ä» npm è·å–](#ä»-npm-è·å–)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
  - [åˆ›å»ºç¬¬ä¸€ä¸ª Numeric](#åˆ›å»ºç¬¬ä¸€ä¸ª-numeric)
  - [é™„åŠ ä¿®é¥°ç¬¦](#é™„åŠ ä¿®é¥°ç¬¦)
  - [è·å–æœ€ç»ˆå€¼](#è·å–æœ€ç»ˆå€¼)
  - [ä½¿ç”¨ä¹˜æ³•ä¿®é¥°ç¬¦](#ä½¿ç”¨ä¹˜æ³•ä¿®é¥°ç¬¦)
- [é«˜çº§åŠŸèƒ½](#é«˜çº§åŠŸèƒ½)
  - [ä¿®é¥°ç¬¦ä¼˜å…ˆçº§ç³»ç»Ÿ](#ä¿®é¥°ç¬¦ä¼˜å…ˆçº§ç³»ç»Ÿ)
  - [æ¡ä»¶ä¿®é¥°ç¬¦](#æ¡ä»¶ä¿®é¥°ç¬¦)
  - [åºåˆ—åŒ–](#åºåˆ—åŒ–)
  - [çº¿ç¨‹å®‰å…¨æ“ä½œ](#çº¿ç¨‹å®‰å…¨æ“ä½œ)
  - [æ€§èƒ½åŸºå‡†æµ‹è¯•](#æ€§èƒ½åŸºå‡†æµ‹è¯•)
- [API å‚è€ƒ](#api-å‚è€ƒ)
- [æ–‡ä»¶è·¯å¾„è¯´æ˜](#æ–‡ä»¶è·¯å¾„è¯´æ˜)
- [ç‰ˆæƒè¯´æ˜](#ç‰ˆæƒè¯´æ˜)

## ä¸‹è½½å’Œéƒ¨ç½²

### ä» GitHub è·å–

```shell
git clone git@github.com:dlqw/NumericSystem.git
```

### ä» npm è·å–

```shell
npm i numericsystem
```

## å¿«é€Ÿå¼€å§‹

### åˆ›å»ºç¬¬ä¸€ä¸ª Numeric

å¼•ç”¨å‘½åç©ºé—´ï¼š

```csharp
using WFramework.CoreGameDevKit.NumericSystem;
```

åˆ›å»º Numeric å¯¹è±¡ï¼š

```csharp
Numeric health = new Numeric(100);
```

æ­¤å€¼ï¼ˆ100ï¼‰ä½œä¸ºåŸºç¡€å€¼æ˜¯åªè¯»çš„ã€‚å¯ä»¥é€šè¿‡ `GetOriginValue()` è·å–åŸå§‹å€¼ï¼š

```csharp
var basicValue = health.GetOriginValue();
```

### é™„åŠ ä¿®é¥°ç¬¦

#### åŠ æ³•ä¿®é¥°ç¬¦

```csharp
// ä½¿ç”¨è¿ç®—ç¬¦ï¼ˆæ¨èï¼‰
health += 20;
health -= 10;

// ä½¿ç”¨æ˜¾å¼æ–¹æ³•
health.AddModifier(new AdditionNumericModifier(20));
health.RemoveModifier(new AdditionNumericModifier(10));
```

#### ä¹˜æ³•ä¿®é¥°ç¬¦

```csharp
// ç™¾åˆ†æ¯”å¢åŠ 
health *= (150, FractionType.Increase);  // +50%

// ç™¾åˆ†æ¯”è¦†ç›–
health *= (200, FractionType.Override);  // Ã—2.0

// ç§»é™¤ä¿®é¥°ç¬¦
health /= (150, FractionType.Increase);
```

### è·å–æœ€ç»ˆå€¼

```csharp
Numeric health = 100;
health += 20.3f;

Debug.Log(health.FinalValue);   // 120 (int)
Debug.Log(health.FinalValueF); // 120.3f (float)
```

### ä½¿ç”¨æ ‡ç­¾å’Œåç§°

```csharp
// åˆ›å»ºå¸¦æ ‡ç­¾å’Œåç§°çš„ä¿®é¥°ç¬¦
health += (20, new[] { "Equipment" }, "Armor", 1);
health *= (120, FractionType.Override, new[] { "Equipment" }, "ArmorUpgrade", 1);
health *= (50, FractionType.Increase, new[] { "Buff" }, "StrengthBoost", 1);
```

### ä½¿ç”¨è‡ªå®šä¹‰ä¿®é¥°ç¬¦

```csharp
Numeric health = 100;

// é™åˆ¶ç”Ÿå‘½å€¼èŒƒå›´
health.ClampMax(150, "MaxHealthCap");
health.ClampMin(0, "MinHealthCap");

// æˆ–ä½¿ç”¨è‡ªå®šä¹‰å‡½æ•°
Func<int, int> healthLimit = value => Mathf.Clamp(value, 0, 150);
health.AddModifier(new CustomNumericModifier(healthLimit));
```

## é«˜çº§åŠŸèƒ½

### ä¿®é¥°ç¬¦ä¼˜å…ˆçº§ç³»ç»Ÿ

ä½¿ç”¨ä¼˜å…ˆçº§æ§åˆ¶ä¿®é¥°ç¬¦çš„åº”ç”¨é¡ºåºï¼š

```csharp
var health = new Numeric(100);

// æ·»åŠ ä¸åŒä¼˜å…ˆçº§çš„ä¿®é¥°ç¬¦
health += (50, new[] { "Base" }, "RaceBonus", 1, ModifierPriority.Base);      // 100
health += (30, new[] { "Base" }, "ClassBonus", 1, ModifierPriority.Base);     // 100
health += (50, new[] { "Equipment" }, "Armor", 1, ModifierPriority.Equipment); // 200
health += (30, new[] { "Buff" }, "Strength", 1, ModifierPriority.Buff);       // 300
health *= (50, FractionType.Increase, Array.Empty<string>(), "Multiplier", 1, ModifierPriority.Multiplier); // 500

// åº”ç”¨é¡ºåºï¼šBase â†’ Equipment â†’ Buff â†’ Multiplier
```

**ä¼˜å…ˆçº§çº§åˆ«ï¼š**
- `Critical` (0) - æœ€é«˜ä¼˜å…ˆçº§
- `Base` (100) - åŸºç¡€å±æ€§
- `Equipment` (200) - è£…å¤‡ä¿®é¥°ç¬¦
- `Buff` (300) - Buff/Debuff æ•ˆæœ
- `Skill` (400) - æŠ€èƒ½åŠ æˆ
- `Default` (400) - é»˜è®¤ä¼˜å…ˆçº§
- `Multiplier` (500) - ç™¾åˆ†æ¯”ä¿®é¥°ç¬¦
- `Clamp` (600) - çº¦æŸä¿®é¥°ç¬¦

### æ¡ä»¶ä¿®é¥°ç¬¦

åŸºäºåŠ¨æ€æ¡ä»¶åº”ç”¨ä¿®é¥°ç¬¦ï¼š

```csharp
var health = new Numeric(100);

// æ¡ä»¶ï¼šç”Ÿå‘½å€¼ä½äº 30%
var lowHpCondition = ConditionBuilder.Where(h => h.FinalValue < 30);
var emergencyShield = ConditionalNumericModifier.ConditionalAdd(
    lowHpCondition,
    50,
    "EmergencyShield"
);
health.AddModifier(emergencyShield);

// ä½¿ç”¨ AND/OR/NOT çš„å¤æ‚æ¡ä»¶
var complexCondition = ConditionBuilder
    .Where(h => h.FinalValue < 50)
    .And(h => h.GetAddModifierValueByTag(new[] { "Buff" }) < 1000000)
    .Build();

health.AddConditionalModifier(
    complexCondition,
    new AdditionNumericModifier(30, Array.Empty<string>(), "ComplexBonus")
);
```

### åºåˆ—åŒ–

ä¿å­˜å’ŒåŠ è½½ä¿®é¥°ç¬¦çŠ¶æ€ï¼š

```csharp
var health = new Numeric(100);
health += 50;
health *= (150, FractionType.Increase);

// åºåˆ—åŒ–
var data = health.Serialize();

// ååºåˆ—åŒ–
var restored = data.Deserialize();
Assert.Equal(health.FinalValue, restored.FinalValue);
```

**æ”¯æŒçš„ä¿®é¥°ç¬¦ï¼š**
- âœ… `AdditionNumericModifier`
- âœ… `FractionNumericModifier`
- âš ï¸ `CustomNumericModifier`ï¼ˆåŒ…å«å§”æ‰˜ï¼‰
- âš ï¸ `ConditionalNumericModifier`ï¼ˆåŒ…å«å§”æ‰˜ï¼‰

### çº¿ç¨‹å®‰å…¨æ“ä½œ

å¤šçº¿ç¨‹åœºæ™¯ä½¿ç”¨ `ThreadSafeNumeric`ï¼š

```csharp
var safeHealth = new ThreadSafeNumeric(100);

// çº¿ç¨‹å®‰å…¨æ“ä½œ
safeHealth += 50;
safeHealth.AddModifier(new FractionNumericModifier(150, FractionType.Increase));

// çº¿ç¨‹å®‰å…¨è¯»å–
var value = safeHealth.FinalValue;

// ä½¿ç”¨å›è°ƒçš„çº¿ç¨‹å®‰å…¨æ“ä½œ
safeHealth.Read(numeric =>
{
    Debug.Log($"ç”Ÿå‘½å€¼: {numeric.FinalValue}");
    Debug.Log($"ä¿®é¥°ç¬¦: {numeric.GetAllModifiers().Count}");
});

safeHealth.Write(numeric =>
{
    numeric += 20;
});
```

### æ€§èƒ½åŸºå‡†æµ‹è¯•

è¿è¡ŒåŸºå‡†æµ‹è¯•ä»¥æµ‹é‡æ€§èƒ½ï¼š

```bash
cd src
dotnet run -c Release --project NumericSystem.Tests -- --filter *NumericBenchmarks*
```

åŸºå‡†æµ‹è¯•ç±»åˆ«ï¼š
- **Basic** - åˆ›å»ºã€ä¿®æ”¹ã€è®¡ç®—
- **Scalability** - å¤§é‡ä¿®é¥°ç¬¦ï¼ˆ10ã€100ã€1000ï¼‰
- **Complex** - çœŸå®åœºæ™¯
- **Fraction** - åˆ†æ•°ä¿®é¥°ç¬¦æ€§èƒ½
- **Query** - æŸ¥è¯¢æ“ä½œ

è¯¦è§ [src/NumericSystem.Tests/Benchmarks/README.md](./src/NumericSystem.Tests/Benchmarks/README.md)

## API å‚è€ƒ

### æµç•… API

```csharp
// æ„å»ºå™¨æ¨¡å¼
var health = Numeric.Build(100, builder =>
{
    builder.AddEquipment(50, "Armor");
    builder.AddBuff(30, "Strength");
    builder.BoostBase(150, "BaseBoost");
    builder.WithMaxLimit(500, "MaxHP");
});

// æ‰©å±•æ–¹æ³•
health.AddEquipment(20, "Helmet");
health.AddBuff(10, "Potion");
health.ClampMax(300);

// æ¡ä»¶æ‰©å±•
health.AddIf(h => h.FinalValue < 100, 50, "EmergencyHeal");
health.MultiplyIf(
    ConditionBuilder.Where(h => h.FinalValue > 200).Build(),
    150,
    FractionType.Increase
);
```

### è¯Šæ–­å·¥å…·

```csharp
var health = new Numeric(100);
health += 50;
health *= (150, FractionType.Increase);

// è·å–ä¿®é¥°ç¬¦ç»Ÿè®¡
var stats = health.GetModifierStats();
foreach (var stat in stats)
{
    Debug.Log($"{stat.Key}: {stat.Value}");
}

// è¾“å‡ºè¯¦ç»†ä¿¡æ¯
health.Dump("ç©å®¶ç”Ÿå‘½å€¼");

// æ£€æŸ¥ç¼“å­˜çŠ¶æ€
Debug.Log(health.GetCacheStatus());
```

## æ–‡ä»¶è·¯å¾„è¯´æ˜

```shell
NumericSystem
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”œâ”€â”€ README_CN.md
â”œâ”€â”€ CHANGELOG.md
â”œâ”€â”€ ARCHITECTURE_REFACTORING_PLAN.md
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚   â””â”€â”€ NumericSystem
â”‚       â”œâ”€â”€ Core/                          # æ ¸å¿ƒæŠ½è±¡
â”‚       â”œâ”€â”€ Chain/                         # è´£ä»»é“¾æ¨¡å¼
â”‚       â”œâ”€â”€ Serialization/                 # åºåˆ—åŒ–æ”¯æŒ
â”‚       â”œâ”€â”€ FixedPoint.cs
â”‚       â”œâ”€â”€ Numeric.cs
â”‚       â”œâ”€â”€ NumericModifier*.cs            # ä¿®é¥°ç¬¦å®ç°
â”‚       â”œâ”€â”€ NumericExtensions.cs           # æ‰©å±•æ–¹æ³•
â”‚       â”œâ”€â”€ ThreadSafeNumeric.cs           # çº¿ç¨‹å®‰å…¨åŒ…è£…
â”‚       â””â”€â”€ DiagnosticHelper.cs            # è¯Šæ–­å·¥å…·
â”‚   â””â”€â”€ NumericSystem.Tests
â”‚       â”œâ”€â”€ Benchmarks/                    # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”‚       â””â”€â”€ *Tests.cs                      # å•å…ƒæµ‹è¯•
â””â”€â”€ LICENSE
```

## æµ‹è¯•

é¡¹ç›®åŒ…å«å…¨é¢çš„å•å…ƒæµ‹è¯•ï¼š

```bash
cd src
dotnet test
```

**æµ‹è¯•è¦†ç›–ï¼š**
- 129 ä¸ªæµ‹è¯•ï¼ˆ100% é€šè¿‡ç‡ï¼‰
- è¦†ç›–æ‰€æœ‰ä¸»è¦åŠŸèƒ½
- è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†

## ç‰ˆæƒè¯´æ˜

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](./LICENSE) å‘å¸ƒ
